<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>我给Openwrt造盔甲 - 极客长斋</title><meta name=Description content="不会做盔甲的码农不是一个合格的矿工"><meta property="og:title" content="我给Openwrt造盔甲"><meta property="og:description" content="不会做盔甲的码农不是一个合格的矿工"><meta property="og:type" content="article"><meta property="og:url" content="https://ryohuang.github.io/posts/build-an-armor-for-openwrt/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-23T12:55:40+08:00"><meta property="article:modified_time" content="2021-02-25T13:41:48+08:00"><meta property="og:site_name" content="极客长斋"><meta name=twitter:card content="summary"><meta name=twitter:title content="我给Openwrt造盔甲"><meta name=twitter:description content="不会做盔甲的码农不是一个合格的矿工"><meta name=application-name content="极客长斋"><meta name=apple-mobile-web-app-title content="极客长斋"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://ryohuang.github.io/posts/build-an-armor-for-openwrt/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"我给Openwrt造盔甲","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ryohuang.github.io\/posts\/build-an-armor-for-openwrt\/"},"genre":"posts","keywords":"openwrt","wordcount":4046,"url":"https:\/\/ryohuang.github.io\/posts\/build-an-armor-for-openwrt\/","datePublished":"2021-02-23T12:55:40+08:00","dateModified":"2021-02-25T13:41:48+08:00","publisher":{"@type":"Organization","name":"阿黄"},"author":{"@type":"Person","name":"阿黄"},"description":"不会做盔甲的码农不是一个合格的矿工"}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=极客长斋>极客长斋</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=极客长斋>极客长斋</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">我给Openwrt造盔甲</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://ryohuang.github.io title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>阿黄</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/document/><i class="far fa-folder fa-fw"></i>document</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-02-23>2021-02-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 4046 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 9 分钟&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/img/armor.jpg data-srcset="/img/armor.jpg, /img/armor.jpg 1.5x, /img/armor.jpg 2x" data-sizes=auto alt=/img/armor.jpg title=不会做盔甲的码农不是一个合格的矿工></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#缘起>缘起</a></li><li><a href=#现状>现状</a></li><li><a href=#理想>理想</a></li><li><a href=#盔甲>盔甲</a><ul><li><a href=#完全开源>完全开源</a></li><li><a href=#不对openwrt进行入侵式修改>不对Openwrt进行入侵式修改</a></li><li><a href=#基于openwrt最新稳定版>基于Openwrt最新稳定版</a></li><li><a href=#优化upnp>优化Upnp</a></li><li><a href=#fullcone-nat>Fullcone NAT</a></li><li><a href=#可以为特别设备设置特别的网关和dns>可以为特别设备设置特别的网关和DNS</a></li><li><a href=#明确的自定义项>明确的自定义项</a></li><li><a href=#github-workflows>github workflows</a></li></ul></li><li><a href=#原理>原理</a></li><li><a href=#尾声>尾声</a></li><li><a href=#致谢>致谢</a></li></ul></nav></div></div><div class=content id=content><h2 id=缘起>缘起</h2><p>那一晚我不该看手机的。</p><p>不看手机就不会知道CDN矿工；不当CDN矿工就不会嫌弃家里的AC86U；不嫌弃AC86U就不会花巨资买个软路由；不买软路由就不会把软路由系统刷个遍；刷了一遍发现我就是想自己做（改）一个软路由系统——立刻马上。</p><h2 id=现状>现状</h2><p>说到路由器系统，特别是软路由，现在热门的无外乎闭源的如爱快、高恪，开源的Openwrt和它的子孙们。至于ROS,pfsense之类在国内稍显冷门的并不在讨论范围之内。对于路由器系统没有什么高低贵贱之分，适合自己，满足自己的需求就好。如果一定要争论个高低的话，就好像争论Debian、CentOS、Manjaro、OpenSUSE、和Ubuntu哪个更好一样，毫无意义。</p><p>我的使用体验是，想给各个软路由系统发好人卡——你很好，但是我们不适合。</p><p>评判之前先说下我的网络环境，尽管是主观感受但也要有客观前提。</p><ul><li>上海电信千兆宽带+2路IPTV+固定电话</li><li>电信光猫拨号并设置DMZ给家庭网关</li><li>一台GEN8，更换E3 CPU,内存12G</li><li>一台TS-551，内存10G</li><li>一台AC 86U</li><li>一台四网口工控机，N4200+4G内存</li><li>若干智能设备，总计约30个设备接入</li></ul><p>按照刷机顺序先说爱快。国内论坛经常听说的一个系统。对于普通家庭用户来说很多功能是多余的，一屏幕的菜单我需要用到的没几个。最近支持了kvm和docker。对于这两个功能，尤其是kvm，我颇有腹诽。一个路由器的系统竟然跑去作为kvm host?有这个硬件条件我肯定让爱快成为虚拟机中的guest!开头在Gen8上尝试虚拟机安装的时候，开头就让我郁闷了——X64版本强制要求4G内存才可以安装。再看看不完善的docker,而且因为闭源无法对它扩展和修改，当时就想换了它。翻翻网上的风评，之前竟然还干过坑用户的事情？还是回到开源世界吧，惹不起。</p><p>再来Openwrt。大名鼎鼎的Openwrt，国内很多路由器系统的爹，包括小米路由器的系统也是由它修改而来的。安装以后第一感受就是<code>瘦</code>。想要个Web UI都需要自己安装。官方原版如果直接让普通用户用，普通用户立刻自闭。而且，它不支持Fullcone NAT，upnp也支持不好。这两个功能对CDN挖矿是致命的，是我财富自由路上的拦路虎。换个符合国情的看看去！</p><p>很容易就找到了Lean&rsquo;s Openwrt，国内大名鼎鼎的Openwrt修改版,github上start数有15k，fork数13.1k。由于加入了很多中国特色的功能，国内社区流行程度很高。我自行编译了一个版本用了一段时间后发现了一些问题。Lean的代码感觉已经离Openwrt官方越来越远。Lean内核版本已经5.x，但是软件源还是18.x。而官方19.x的版本还在用4.x的内核版本。这就导致安装ipk的时候很容易发生依赖冲突。Lean那边看着也没有跟随官方版本升级的意思。眼看这今年Openwrt要出21.02了，我等不起啊。</p><p>最后我看了看老朋友Gargoyle的代码。稍显另类的一个Openwrt衍生版本。它基于Openwrt的系统但是没有采用luci作为界面。曾经因为它的QoS功能而闻名，也作为我之前的路由器固件运行了好久。今时今日，很多人认为Openwrt上最好的QoS是SQM而不是它了，但是至少他的代码组织方式和编译过程给了我很大的启发。</p><blockquote><p>以上我只列举了我认为的缺陷和离开某个固件的理由，并没有任何指责和批评的意思。所有的开源项目都是在无私奉献，向作者们致敬。</p></blockquote><h2 id=理想>理想</h2><p>发完好人卡，我们来谈谈我理想的软路由系统。</p><p>Lean的系统很好，功能丰富，社区活跃。只是他的做法是直接在Openwrt上做修改，修改越来越多，也就离官方源越来越远。Openwrt现在已经在筹备Openwrt 21.02的发布，并且在未来luci将被luci2所替代。我很担心到时候Lean和Openwrt完全分道扬镳。之前Openwrt分支出去的LEDE，后来两者又合并的故事想必大家都有耳闻吧？</p><p>因为Lean对Openwrt的改动直接触及其筋骨，改出来的版本还很利害，这个过程像极了金刚狼的诞生。而我在想，能不能尽量保持Openwrt的原样，但是给他打造一幅盔甲。这套盔甲现在的Openwrt能够穿，稍微改动下将来的Openwrt(例如即将到来的21.02版本)也能穿。对，就像钢铁侠的盔甲一样。</p><h2 id=盔甲>盔甲</h2><p>对着电脑一顿输出，盔甲造好了在<a href=https://github.com/ryohuang/slim-wrt target=_blank rel="noopener noreffer">这里:slim-wrt</a>。Slim-wrt意为给小小的Openwrt穿上盔甲，盔甲型号暂且算它是Mark I。</p><ul><li>完全开源</li><li>不对Openwrt进行入侵式修改</li><li>基于Openwrt最新稳定版</li><li>优化Upnp</li><li>Fullcone NAT</li><li>可以为特别设备设置特别的网关和DNS</li><li>明确的自定义项</li><li>github workflows</li></ul><h3 id=完全开源>完全开源</h3><p>这个不用多说，代码全在github上了。</p><h3 id=不对openwrt进行入侵式修改>不对Openwrt进行入侵式修改</h3><p>我没有直接fork一份Openwrt的代码修改。我把要改动的地方都分别做了补丁保存在以feature命名的文件夹中了，要用到的应用也在仓库中保存。在编译的时候对Openwrt的补丁被打入，自定义的应用通过自定义feed的方式合入整个版本中。</p><h3 id=基于openwrt最新稳定版>基于Openwrt最新稳定版</h3><p>现在的工作分支是按照19.07执行的，之后会新增21.02。我相信大多数补丁和应用还能沿用。写完这一篇之后会新建branch去尝试Openwrt的新版本。</p><h3 id=优化upnp>优化Upnp</h3><p>upnp功能一直被用户诟病，Lean也对它采取了一些特殊处理，据说是停留在旧版本没有升级。我发现的问题是，在DMZ后一些CDN挖矿软件认为Upnp功能没有开启。对此我写了个简单的程序，就是仓库中的<code>slimapps/application/luci-app-boostupnp</code>。这部分之后会撰文说明。</p><h3 id=fullcone-nat>Fullcone NAT</h3><p>Fullcone NAT默认不被Openwrt支持，而CDN挖矿需要它。相关的patch在Openwrt的论坛上早有讨论，但是人家不合啊！Fullcone NAT的补丁在<a href=https://github.com/Chion82/netfilter-full-cone-nat.git target=_blank rel="noopener noreffer">这里</a>,Lean也是利用了这一份patch。</p><h3 id=可以为特别设备设置特别的网关和dns>可以为特别设备设置特别的网关和DNS</h3><p>看着很拗口的一个功能，因为一些无法说出口的原因。假设我家里有两个网关和DNS(为什么要有两个网关？不许问)。A直通国内，B直通世界。家里几乎所有设备要连A,少数设备连接B。这个app就是解决这个问题的——如何制定某些设备连接B。这个功能在<code>slimapps/application/luci-app-taghost</code>。
说到这里插一句，很多博主都吹双软路由，主路由的默认网关设置为副路由地址，副路由的默认网关设置为主路由的地址，DHCP由主路由提供。这神奇的玩法有没有什么不对劲？这哪里是主副路由啊，这是两个路由器串联，其中一个路由器挂了就全完了！</p><figure><img src=/drawio/dual-routers.drawio.png><figcaption><h4>现在流行的双软路由下的数据走向</h4></figcaption></figure><h3 id=明确的自定义项>明确的自定义项</h3><p>对于自定义功能，我做了两方面的努力。</p><ol><li><p>将功能相关的patch放在各个以功能名称命名的目录下。Openwrt的功能可能会涉及各个模块。这里带一下，Openwrt的很多功能都是依赖第三方<code>feeds</code>的（这也是国内编译麻烦的地方，很多第三方下不到啊！）所以我人为地以git仓库为依据将openwrt分为了openwrt和feeds。每个功能命名的目录下可以包含openwrt目录，用于对openwrt部分打补丁，feeds/*对feeds打补丁，除此之外如果有特殊需求可以在目录下建立custom.sh做一些额外动作。这样做的好处是清晰，易定制。再也不用到commit里的海洋里去大海捞针了。</p></li><li><p>Openwrt的编译配置在.config里面，这个文件需要make menuconfig生成。对于默认配置和自定义功能，Lean的做法是修改target的makefile，而那个makefile里面又带了很多我用不到的东西（比如迅雷加速）。Gargoyle的做法是直接提供了.config文件，如果想自定义的话还是需要make menuconfig。我的做法是使用/profiles/slim/config这样的配置文件，再执行make defconfig完成.config的生成。这样的配置文件简单易读易配置，也容易传播。</p></li></ol><p>所以，当你想自定路由器功能的时候，可以看看patch-modules下的目录然后再看看config文件,自定义的工作就完成了。</p><h3 id=github-workflows>github workflows</h3><p>是的，我另外写了workflows用于固件的编译和版本的发布。我再也不想在本地编译了，而是利用美国大公司的服务器编。当完成自定义功能后，提交上去，打个tag，boom，你要的固件好了。很快啊！</p><h2 id=原理>原理</h2><p>所谓一图胜千言，我放两张图。</p><figure><img src=/drawio/openwrt.drawio.png><figcaption><h4>openwrt build process</h4></figcaption></figure><p>上面是Openwrt原始的编译过程</p><figure><img src=/drawio/slimbuild.drawio.png><figcaption><h4>slim build process</h4></figcaption></figure><p>上面是slim-wrt的编译过程，原理都在图里了。流程都在下面了，代码都在github上了。</p><ol><li>加入自定义的feed，指向本项目的slimapps目录。具体每个app做什么会在其目录下另写文档，在此不再赘述。</li><li>对openwrt应用补丁。遍历<code>patches-modules</code>下所有目录中，如果包含<code>openwrt</code>则应用其中的patch文件。例如<code>patches-modules/0001-fullcone-nat/openwrt</code></li><li>对<code>feeds</code>进行补丁。遍历<code>patches-modules</code>下所有目录中，如果包含<code>feeds</code>则应用其中的patch文件。</li><li>配置每个项目的profile，拷贝到openwrt根目录下之后执行defconfig就会生成相应配置。</li><li>配置生成后再额外补充一些内容到.config文件。</li><li>make，等待之后固件就生出来了。</li></ol><h2 id=尾声>尾声</h2><p>终于，Openwrt穿上盔甲后CDN挖矿的网络环境满足了。看着100M上传带宽换来的每天4块钱感觉离财富自由越来越近了。不，其实这个根本不重要了。事实上，电费加上设备的损耗，我很可能是亏的。</p><p>重要的是有个想法，找找方法，然后真的做到了，自high一番再接着找下一个目标。slim-wrt并不想取代任何的路由器固件，只是有这么一种玩法我给公开了出来。</p><h2 id=致谢>致谢</h2><p>查阅资料的时候参考了各位大佬的内容，在此一并感谢。排名不分先后，全看复制黏贴。</p><ul><li><a href=https://openwrt.org target=_blank rel="noopener noreffer">Openwrt</a></li><li><a href=https://www.gargoyle-router.com target=_blank rel="noopener noreffer">gargoyle</a></li><li><a href=https://github.com/coolsnowwolf/lede target=_blank rel="noopener noreffer">Lean</a></li><li><a href=https://github.com/jerrykuku/luci-theme-argon.git target=_blank rel="noopener noreffer">jerrykuku</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2021-02-25</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://ryohuang.github.io/posts/build-an-armor-for-openwrt/ data-title=我给Openwrt造盔甲 data-hashtags=openwrt><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://ryohuang.github.io/posts/build-an-armor-for-openwrt/ data-hashtag=openwrt><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://ryohuang.github.io/posts/build-an-armor-for-openwrt/ data-title=我给Openwrt造盔甲><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://ryohuang.github.io/posts/build-an-armor-for-openwrt/ data-title=我给Openwrt造盔甲><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a><a href=javascript:void(0); title="分享到 Pocket" data-sharer=pocket data-url=https://ryohuang.github.io/posts/build-an-armor-for-openwrt/><i class="fab fa-get-pocket fa-fw"></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://ryohuang.github.io/posts/build-an-armor-for-openwrt/ data-title=我给Openwrt造盔甲 data-image=/img/armor.jpg><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/openwrt/>openwrt</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.81.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://ryohuang.github.io/ target=_blank>R.Huang/阿黄</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=https://ryohuang.disqus.com/embed.js defer></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>